name: ğŸ—ï¸ Build Windows .exe

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'main.py'
      - 'requirements.txt'
      - 'gasongjiang.spec'
      - '.github/workflows/build-windows.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build Windows .exe
    runs-on: windows-latest

    strategy:
      matrix:
        python-version: ['3.11']

    steps:
      # Step 1: Checkout code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      # Step 3: Display Python info
      - name: â„¹ï¸ Display Python version
        run: python -c "import sys; print(f'Python {sys.version}')"

      # Step 4: Create virtual environment
      - name: ğŸ”§ Create virtual environment
        run: |
          python -m venv venv
          .\venv\Scripts\activate.bat

      # Step 5: Upgrade pip
      - name: â¬†ï¸ Upgrade pip, setuptools, wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      # Step 6: Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r requirements-windows.txt

      # Step 7: Build Windows executable
      - name: ğŸ—ï¸ Build Windows executable with PyInstaller
        run: |
          pyinstaller gasongjiang.spec
        continue-on-error: true

      # Step 8: Fallback build (if spec file fails)
      - name: ğŸ”„ Fallback build method
        if: failure()
        run: |
          pyinstaller `
            --onefile `
            --windowed `
            --name="ê°€ì†¡ì¥_ìƒì„±ê¸°" `
            main.py

      # Step 9: Check if exe was created
      - name: âœ… Verify build output
        run: |
          if (Test-Path "dist\ê°€ì†¡ì¥_ìƒì„±ê¸°.exe") {
            echo "âœ… .exe file created successfully"
            $size = (Get-Item "dist\ê°€ì†¡ì¥_ìƒì„±ê¸°.exe").Length / 1MB
            echo "ğŸ“Š File size: $([Math]::Round($size, 2)) MB"
          } else {
            echo "âŒ .exe file not found"
            exit 1
          }

      # Step 10: Upload artifact
      - name: ğŸ“¤ Upload .exe as artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ê°€ì†¡ì¥_ìƒì„±ê¸°-windows-exe
          path: dist/ê°€ì†¡ì¥_ìƒì„±ê¸°.exe
          retention-days: 30

      # Step 11: Create release (on version tags)
      - name: ğŸ·ï¸ Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ê°€ì†¡ì¥_ìƒì„±ê¸° ${{ github.ref_name }}
          body: |
            # ê°€ì†¡ì¥ ìƒì„±ê¸° Release

            ## Download
            - **Windows .exe**: Download below

            ## Features
            - âœ… Generate unique 14-digit tracking numbers
            - âœ… Upload Excel files
            - âœ… Export with formatting
            - âœ… Guaranteed uniqueness
            - âœ… 100% local processing

            ## Installation
            Just download and run `ê°€ì†¡ì¥_ìƒì„±ê¸°.exe` - no Python needed!

            ## What's New
            See commits for details.
          draft: false
          prerelease: false

      # Step 12: Upload to release
      - name: ğŸ“¦ Upload .exe to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/ê°€ì†¡ì¥_ìƒì„±ê¸°.exe
          asset_name: ê°€ì†¡ì¥_ìƒì„±ê¸°.exe
          asset_content_type: application/octet-stream

      # Step 13: Success notification
      - name: ğŸ“¨ Build Success Summary
        if: success()
        run: |
          echo "=============================================="
          echo "âœ… BUILD SUCCESSFUL!"
          echo "=============================================="
          echo ""
          echo "ğŸ“Š Build Details:"
          echo "  - Framework: Python + PyInstaller"
          echo "  - Python: ${{ matrix.python-version }}"
          echo "  - OS: Windows Latest"
          echo "  - Output: dist/ê°€ì†¡ì¥_ìƒì„±ê¸°.exe"
          echo ""
          echo "âœ¨ Artifact available for download!"
          echo "=============================================="

  # Optional: Build on macOS for .app
  build-macos:
    name: Build macOS .app
    runs-on: macos-latest

    strategy:
      matrix:
        python-version: ['3.11']

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ”§ Create virtual environment
        run: |
          python -m venv venv
          source venv/bin/activate

      - name: â¬†ï¸ Upgrade pip
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r requirements.txt

      - name: ğŸ—ï¸ Build macOS .app
        run: |
          pyinstaller gasongjiang.spec

      - name: ğŸ“¤ Upload .app as artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ê°€ì†¡ì¥_ìƒì„±ê¸°-macos-app
          path: dist/ê°€ì†¡ì¥_ìƒì„±ê¸°.app
          retention-days: 30
